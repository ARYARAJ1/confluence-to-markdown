<!DOCTYPE html>
<html>
    <head>
        <title>SDI : Data Warehouse Loading Process POC</title>
        <link rel="stylesheet" href="styles/site.css" type="text/css" />
        <META http-equiv="Content-Type" content="text/html; charset=UTF-8">
    </head>

    <body class="theme-default aui-theme-default">
        <div id="page">
            <div id="main" class="aui-page-panel">
                <div id="main-header">
                    <div id="breadcrumb-section">
                        <ol id="breadcrumbs">
                            <li class="first">
                                <span><a href="index.html">SDI</a></span>
                            </li>
                                                    <li>
                                <span><a href="1205338136.html">Decisions/POCs</a></span>
                            </li>
                                                    <li>
                                <span><a href="Data-Warehouse-POC_1070989328.html">Data Warehouse POC</a></span>
                            </li>
                                                </ol>
                    </div>
                    <h1 id="title-heading" class="pagetitle">
                                                <span id="title-text">
                            SDI : Data Warehouse Loading Process POC
                        </span>
                    </h1>
                </div>

                <div id="content" class="view">
                    <div class="page-metadata">
                        
        
    
        
    
        
        
            Created by <span class='author'> Sarah Fan (Deactivated)</span>, last modified on Feb 08, 2021
                        </div>
                    <div id="main-content" class="wiki-content group">
                    <h1 id="DataWarehouseLoadingProcessPOC-Introduction">Introduction</h1><p>The following code provides a toy example of performing <a href="https://vmia.atlassian.net/wiki/spaces/SDI/pages/567148575/Data+Warehouse+Loading+Pattern+Design?focusedCommentId=606732305#comment-606732305" data-card-appearance="inline" rel="nofollow">https://vmia.atlassian.net/wiki/spaces/SDI/pages/567148575/Data+Warehouse+Loading+Pattern+Design?focusedCommentId=606732305#comment-606732305</a> in the <a href="Data-Warehouse-Pipeline---3.-Process_469860353.html" data-linked-resource-id="469860353" data-linked-resource-version="42" data-linked-resource-type="page">Data Warehouse Pipeline - 3. Process</a>.</p><p>The <strong>purpose </strong>of the POC is (as stated in the <a href="https://vmia.atlassian.net/browse/SDID-1479" class="external-link" rel="nofollow">Jira ticket</a>):</p><ul><li><p>SP POC: Can retrieve and prepare <strong>config </strong>that stored procedures can directly consume. <strong>output</strong>: config structure that can be populated is confirmed</p></li><li><p>SP POC: Can run the stored procedures following the proposed <strong>loading pattern</strong>. Combine bespoke transformation with a generic SP that handles audit columns and things like update logic. Create a real version of how this will work. <strong>output</strong>: stored procedure(s) code structure well defined</p></li><li><p>Sequential Dependency POC: When running the pipeline in parallel and in sequence for multiple data warehouse tables using config, demonstrate the debugging process using ADF Monitor. POC should have two loops so we can prove out operating both and debugging where the error is the <strong>output</strong>: prove that debugging which SP'S failed and how much of the whole pipeline executed is a workable process</p></li></ul><p /><style type='text/css'>/*<![CDATA[*/
div.rbtoc1639539527114 {padding: 0px;}
div.rbtoc1639539527114 ul {list-style: disc;margin-left: 0px;}
div.rbtoc1639539527114 li {margin-left: 0px;padding-left: 0px;}

/*]]>*/</style><div class='toc-macro rbtoc1639539527114'>
<ul class='toc-indentation'>
<li><span class='TOCOutline'>1</span> <a href='#DataWarehouseLoadingProcessPOC-Introduction'>Introduction</a></li>
<li><span class='TOCOutline'>2</span> <a href='#DataWarehouseLoadingProcessPOC-DevelopmentProcess'>Development Process</a>
<ul class='toc-indentation'>
<li><span class='TOCOutline'>2.1</span> <a href='#DataWarehouseLoadingProcessPOC-Step1:SetupMockTables'>Step 1: Setup Mock Tables</a></li>
<li><span class='TOCOutline'>2.2</span> <a href='#DataWarehouseLoadingProcessPOC-Step2:PrepareSQLVersionofCode'>Step 2: Prepare SQL Version of Code</a></li>
<li><span class='TOCOutline'>2.3</span> <a href='#DataWarehouseLoadingProcessPOC-Step3:TranslateSQLCodeintoStoredProcedures'>Step 3: Translate SQL Code into Stored Procedures</a></li>
<li><span class='TOCOutline'>2.4</span> <a href='#DataWarehouseLoadingProcessPOC-Step4:BuildthePipelineinADF'>Step 4: Build the Pipeline in ADF</a></li>
</ul>
</li>
<li><span class='TOCOutline'>3</span> <a href='#DataWarehouseLoadingProcessPOC-VariationtotheOriginalDesign'>Variation to the Original Design</a>
<ul class='toc-indentation'>
<li><span class='TOCOutline'>3.1</span> <a href='#DataWarehouseLoadingProcessPOC-ChangenestedForEachLoopintoForEachLoop+sub-pipelinefortheStarSchemaPipeline'>Change nested ForEach Loop into ForEach Loop + sub-pipeline for the Star Schema Pipeline</a></li>
<li><span class='TOCOutline'>3.2</span> <a href='#DataWarehouseLoadingProcessPOC-SplittheExecuteLoadingStoredProcedureintoThreeModularisedStoredProcedure'>Split the Execute Loading Stored Procedure into Three Modularised Stored Procedure</a></li>
</ul>
</li>
<li><span class='TOCOutline'>4</span> <a href='#DataWarehouseLoadingProcessPOC-Config'>Config</a>
<ul class='toc-indentation'>
<li><span class='TOCOutline'>4.1</span> <a href='#DataWarehouseLoadingProcessPOC-TableTypeConfig'>Table Type Config</a></li>
<li><span class='TOCOutline'>4.2</span> <a href='#DataWarehouseLoadingProcessPOC-TableConfig'>Table Config</a></li>
</ul>
</li>
<li><span class='TOCOutline'>5</span> <a href='#DataWarehouseLoadingProcessPOC-DevelopmentandDebuginADP'>Development and Debug in ADP</a>
<ul class='toc-indentation'>
<li><span class='TOCOutline'>5.1</span> <a href='#DataWarehouseLoadingProcessPOC-LookupActivity'>Lookup Activity</a></li>
<li><span class='TOCOutline'>5.2</span> <a href='#DataWarehouseLoadingProcessPOC-ForEachLoop'>ForEach Loop</a></li>
</ul>
</li>
</ul>
</div><h1 id="DataWarehouseLoadingProcessPOC-DevelopmentProcess">Development Process</h1><h2 id="DataWarehouseLoadingProcessPOC-Step1:SetupMockTables">Step 1: Setup Mock Tables</h2><div class="code panel pdl" style="border-width: 1px;"><div class="codeContent panelContent pdl">
<pre class="syntaxhighlighter-pre" data-syntaxhighlighter-params="brush: java; gutter: false; theme: Confluence" data-theme="Confluence">use database &lt;database_name&gt;;
create or replace table &lt;schema_name&gt;.source_1 (
 col1 int,
 col2 string,
 col3 float,
 system_valid_from timestamp,
 system_valid_to timestamp,
 current_flag boolean,
 insert_run_id string,
 update_run_id string,
 record_insert_datetime timestamp,
 record_update_datetime timestamp,
 is_delete_flag boolean,
 exp_batch_datetime timestamp
);

create or replace table &lt;schema_name&gt;.source_2 (
 col1 int,
 col2 string,
 col3 float,
 col4 int,
 system_valid_from timestamp,
 system_valid_to timestamp,
 current_flag boolean,
 insert_run_id string,
 update_run_id string,
 record_insert_datetime timestamp,
 record_update_datetime timestamp,
 is_delete_flag boolean,
 exp_batch_datetime timestamp
);

create or replace table &lt;schema_name&gt;.dest_12 (
 col1 int,
 col12 string,
 col13 float,
 col4 int,
 system_valid_from timestamp,
 system_valid_to timestamp,
 current_flag boolean,
 insert_run_id string,
 update_run_id string,
 record_insert_datetime timestamp,
 record_update_datetime timestamp,
 is_delete_flag boolean,
 exp_batch_datetime timestamp
);

insert into &lt;schema_name&gt;.source_1
  values
  (1, &#39;abc&#39;, 12.23, &#39;2021-01-26 00:00:00.000 -0800&#39;::timestamp, &#39;9999-12-31 00:00:00.000 -0800&#39;::timestamp,1, &#39;1&#39;, NULL, &#39;2021-01-27 15:56:26.342 -0800&#39;::timestamp, NULL, 0, &#39;2021-01-26 09:00:00.000 -0800&#39;::timestamp),
  (2, &#39;cde&#39;, 23.451, &#39;2021-01-26 00:00:00.000 -0800&#39;::timestamp, &#39;9999-12-31 00:00:00.000 -0800&#39;::timestamp,1, &#39;1&#39;, NULL, &#39;2021-01-27 15:56:26.342 -0800&#39;::timestamp, NULL, 0, &#39;2021-01-26 09:00:00.000 -0800&#39;::timestamp),
  (3, &#39;dfg&#39;, 45.67, &#39;2021-01-26 00:00:00.000 -0800&#39;::timestamp, &#39;9999-12-31 00:00:00.000 -0800&#39;::timestamp,1, &#39;1&#39;, NULL, &#39;2021-01-27 15:56:26.342 -0800&#39;::timestamp, NULL, 0, &#39;2021-01-26 09:00:00.000 -0800&#39;::timestamp);

insert into &lt;schema_name&gt;.source_2
  values
  (2, &#39;cde&#39;, 23.45,22, &#39;2021-01-24 10:00:00.000 -0800&#39;::timestamp, &#39;9999-12-31 00:00:00.000 -0800&#39;::timestamp,1,  &#39;1&#39;, NULL, &#39;2021-01-27 15:56:26.342 -0800&#39;::timestamp, NULL, 0, &#39;2021-01-25 00:00:00.000 -0800&#39;::timestamp),
  (3, &#39;dfg&#39;, 45.67,33, &#39;2021-01-24 10:00:00.000 -0800&#39;::timestamp, &#39;9999-12-31 00:00:00.000 -0800&#39;::timestamp,1,&#39;1&#39;, NULL, &#39;2021-01-27 15:56:26.342 -0800&#39;::timestamp, NULL, 0, &#39;2021-01-25 00:00:00.000 -0800&#39;::timestamp),
  (4, &#39;hji&#39;, 67.89,44, &#39;2021-01-24 10:00:00.000 -0800&#39;::timestamp, &#39;9999-12-31 00:00:00.000 -0800&#39;::timestamp,1,&#39;1&#39;, NULL, &#39;2021-01-27 15:56:26.342 -0800&#39;::timestamp, NULL, 0, &#39;2021-01-25 00:00:00.000 -0800&#39;::timestamp);

insert into &lt;schema_name&gt;.dest_12
  values
  (2, &#39;bbb&#39;, 23.45,22, &#39;2021-01-20 10:00:00.000 -0800&#39;::timestamp, &#39;9999-12-31 00:00:00.000 -0800&#39;::timestamp,1,  &#39;0&#39;, NULL, &#39;2021-01-21 15:56:26.342 -0800&#39;::timestamp, NULL, 0, &#39;2021-01-21 00:00:00.000 -0800&#39;::timestamp);

create or replace table &lt;schema_name&gt;.dest_34 like &lt;schema_name&gt;.dest_12;
create or replace table &lt;schema_name&gt;.dest_56 like &lt;schema_name&gt;.dest_12;</pre>
</div></div><h2 id="DataWarehouseLoadingProcessPOC-Step2:PrepareSQLVersionofCode">Step 2: Prepare SQL Version of Code</h2><ul><li><p>Validate SQL code is doing the expected things</p></li></ul><div class="code panel pdl" style="border-width: 1px;"><div class="codeContent panelContent pdl">
<pre class="syntaxhighlighter-pre" data-syntaxhighlighter-params="brush: java; gutter: false; theme: Confluence" data-theme="Confluence">use database &lt;database_name&gt;;

# create transient table
create transient table temp_1 as  
select a.col1 as col1, a.col2 as col12, a.col3 as col13, b.col4 as col4, a.system_valid_from, b.system_valid_to
, case when b.system_valid_to = &#39;9999-12-31 00:00:00.000 -0800&#39;::timestamp then 1 else 0 end as current_flag
, a.is_delete_flag
from
(select col1, col2, col3, system_valid_from, system_valid_to, is_delete_flag from &lt;schema_name&gt;.source_1 where exp_batch_datetime = &#39;2021-01-26 09:00:00.000 -0800&#39;::timestamp) as a
left join
(select col1, col2, col3, col4, system_valid_from, system_valid_to from &lt;schema_name&gt;.source_2) as b
on a.col1 = b.col1 and (a.system_valid_from &lt; b.system_valid_to and a.system_valid_to &gt;= b.system_Valid_to)
where b.col1 is not NULL


# update outdated records
update &lt;schema_name&gt;.dest_12
set current_flag = 0, system_valid_to = c.system_valid_from, update_run_id = 123, record_update_datetime = current_timestamp()
from (select b.* from 
(select * from &lt;schema_name&gt;.dest_12 where md5(concat_ws(&#39;|@|&#39;, col1)) in (select md5(concat_ws(&#39;|@|&#39;, col1)) from temp_1)
and md5(concat_ws(&#39;|@|&#39;, col12, col13, col4)) not in (select md5(concat_ws(&#39;|@|&#39;, col12, col13, col4)) from temp_1)
and current_flag = 1) as a
inner join
(select * from temp_1) as b
on a.col1 = b.col1) as c
where &lt;schema_name&gt;.dest_12.current_flag = 1 and &lt;schema_name&gt;.dest_12.col1 = c.col1


# insert existing records with updates and new records
insert into &lt;schema_name&gt;.dest_12
select col1, col12, col13, col4, system_valid_from, system_valid_to, 1 as current_flag
, 11, NULL
, current_timestamp(), NULL
, is_delete_flag
, &#39;2021-01-26 09:00:00.000 -0800&#39;::timestamp
from (
select *
from temp_1 
where md5(concat_ws(&#39;|@|&#39;, col1)) not in (select md5(concat_ws(&#39;|@|&#39;, col1)) from &lt;schema_name&gt;.dest_12)
union
select * from temp_1
where md5(concat_ws(&#39;|@|&#39;, col1)) in (select md5(concat_ws(&#39;|@|&#39;, col1)) from &lt;schema_name&gt;.dest_12) and
md5(concat_ws(&#39;|@|&#39;, col12, col13, col4)) not in (select md5(concat_ws(&#39;|@|&#39;, col12, col13, col4)) from &lt;schema_name&gt;.dest_12)) as a</pre>
</div></div><h2 id="DataWarehouseLoadingProcessPOC-Step3:TranslateSQLCodeintoStoredProcedures">Step 3: Translate SQL Code into Stored Procedures</h2><p>From SQL to Stored Procedure:</p><ol><li><p>make sure the sql_str is a direct the translation of the SQL code in Step 2. Can just return the sql_str from the stored procedure to ensure the sql_str is produced properly (execute the returned sql_str manually).</p></li><li><p>parameterise the component associated with runtime (i.e. information that only would available during the runtime).</p></li><li><p>add in all the standard code: execute the sql_str, grab the technical metadata, return the object.</p></li><li><p>clear out the destination table and run the stored procedure, and check the output to ensure the stored procedure is doing what’s expected.</p></li></ol><div class="code panel pdl" style="border-width: 1px;"><div class="codeContent panelContent pdl">
<pre class="syntaxhighlighter-pre" data-syntaxhighlighter-params="brush: java; gutter: false; theme: Confluence" data-theme="Confluence">use database &lt;database_name&gt;;
CREATE OR REPLACE PROCEDURE check_if_processed(TABLE_NAME VARCHAR, EXP_BATCH_DATETIME VARCHAR)
  RETURNS string not null
  LANGUAGE JAVASCRIPT
  AS
  $$
  
    var return_obj = {};
  
//  check if the batch has been processed successfully by checking the EXP_BATCH_DATETIME in the destination table by TABLE_NAME
  var sql_str = &quot;select count(*) from &quot; + TABLE_NAME + &quot; where EXP_BATCH_DATETIME = &#39;&quot; + EXP_BATCH_DATETIME + &quot;&#39;::timestamp&quot;
  var response = snowflake.execute({
      sqlText: sql_str,    
  });
  var sf_query_id = response.getQueryId();
  return_obj[&#39;sf_query_id&#39;] = sf_query_id;
  return_obj[&#39;sql_str&#39;] = sql_str;
  
  var sf_query_output_key = response.getColumnName(1);
  response.next();
  var sf_query_output_value = response.getColumnValue(1);
  return_obj[sf_query_output_key] = sf_query_output_value

  if (sf_query_output_value &gt; 0) {
    return_obj[&#39;status&#39;] = &quot;processed&quot;
    return_obj[&#39;detail&#39;]  = &#39;Table &#39; + TABLE_NAME + &#39; has already succesfully processed batch &#39; + EXP_BATCH_DATETIME + &#39; and therefore skip the process.&#39;
    return JSON.stringify(return_obj)
  } else {
    return_obj[&#39;status&#39;] = &quot;not yet&quot;
    return_obj[&#39;detail&#39;]  = &#39;No record is found in Table &#39; + TABLE_NAME + &#39; for batch &#39; + EXP_BATCH_DATETIME + &#39; and therefore will process.&#39;
    return JSON.stringify(return_obj)
  }
  $$;

call check_if_processed(&#39;&lt;schema_name&gt;.dest_34&#39;, &#39;2021-01-26 09:00:00.000 -0800&#39;)



CREATE OR REPLACE PROCEDURE create_dim_table12_transient(TABLE_NAME VARCHAR, HIGH_DATETIME VARCHAR, EXP_BATCH_DATETIME VARCHAR)
  RETURNS string not null
  LANGUAGE JAVASCRIPT
  AS
  $$
  
  var return_obj = {};
  
//  create the transient table by applying custom joins and filters
  
  var dest_table_name = TABLE_NAME + &quot;_transient&quot;
  var sql_str = &quot;create or replace transient table &quot; + dest_table_name + &quot; as &quot;
    + &quot;select a.col1 as col1, a.col2 as col12, a.col3 as col13, b.col4 as col4, a.system_valid_from, b.system_valid_to, &quot;
    + &quot;case when b.system_valid_to = &#39;&quot; + HIGH_DATETIME + &quot;&#39;::timestamp then 1 else 0 end as current_flag, a.is_delete_flag &quot;
    + &quot;from (select col1, col2, col3, system_valid_from, system_valid_to, is_delete_flag from &lt;schema_name&gt;.source_1 where exp_batch_datetime = &#39;&quot;
    + EXP_BATCH_DATETIME + &quot;&#39;::timestamp) as a left join &quot;
    + &quot;(select col1, col2, col3, col4, system_valid_from, system_valid_to from &lt;schema_name&gt;.source_2) as b &quot;
    + &quot;on a.col1 = b.col1 and (a.system_valid_from &lt; b.system_valid_to and a.system_valid_to &gt;= b.system_Valid_to) where b.col1 is not NULL&quot;

  var response = snowflake.execute({
      sqlText: sql_str,    
  });
    
//  extract technical metadata from the Snowflake resultSet
  
  var sf_query_id = response.getQueryId();
  return_obj[&#39;sf_query_id&#39;] = sf_query_id;
  return_obj[&#39;sql_str&#39;] = sql_str;
  
  var sf_query_output_key = response.getColumnName(1);
  response.next();
  var sf_query_output_value = response.getColumnValue(1);
  return_obj[&#39;status&#39;] = &#39;succeeded&#39;
  return_obj[&#39;detail&#39;] = sf_query_output_value
    
  return JSON.stringify(return_obj)
  $$;

call create_dim_table12_transient(&#39;&lt;schema_name&gt;.dest_12&#39;, &#39;9999-12-31 00:00:00.000 -0800&#39;, &#39;2021-01-26 09:00:00.000 -0800&#39;)



CREATE OR REPLACE PROCEDURE scd_type2_loading(TABLE_NAME VARCHAR, HASH_DELIMITER VARCHAR, PRIMARY_KEY_LIST ARRAY, ATTR_COL_LIST ARRAY, RUN_ID STRING, EXP_BATCH_DATETIME VARCHAR)   //procedure call the above procedure
  RETURNS string not null
  LANGUAGE JAVASCRIPT
  AS
  $$
  
  var return_obj = {};
  
//  String preparation
   
   var temp_table_name = TABLE_NAME + &quot;_transient&quot;
   var PRIMARY_KEY_STR = PRIMARY_KEY_LIST.join(&#39;,&#39;)
   var ATTR_COL_STR = ATTR_COL_LIST.join(&#39;,&#39;)
   
   var ON_string_pattern = &#39;a.&lt;key&gt; = b.&lt;key&gt;&#39;
   var ON_string_list = PRIMARY_KEY_LIST.map(function(e) { 
      var r = ON_string_pattern.replace(/&lt;key&gt;/g, e); // /../g: global replacement
      return r;
    });
   var On_string = ON_string_list.join(&#39; and &#39;)
   
   var WHERE_string_pattern = &#39;&lt;dest_table&gt;.&lt;key&gt; = c.&lt;key&gt;&#39;
   var WHERE_string_list = PRIMARY_KEY_LIST.map(function(e) { 
      var r = WHERE_string_pattern.replace(&#39;&lt;dest_table&gt;&#39;, TABLE_NAME).replace(/&lt;key&gt;/g, e);
      return r;
    });
   var WHERE_string = WHERE_string_list.join(&#39; and &#39;);


//  update outdated records
  
  var sql_str = &quot;update &quot; + TABLE_NAME + &quot; set current_flag = 0, system_valid_to = c.system_valid_from, update_run_id = &#39;&quot; + RUN_ID + &quot;&#39;, record_update_datetime = current_timestamp() &quot;
    + &quot;from (select b.* from &quot;
    + &quot;(select * from &quot; + TABLE_NAME + &quot; where md5(concat_ws(&#39;&quot; + HASH_DELIMITER + &quot;&#39;, &quot; + PRIMARY_KEY_STR + &quot;)) in (select md5(concat_ws(&#39;&quot; + HASH_DELIMITER + &quot;&#39;, &quot; + PRIMARY_KEY_STR + &quot;)) from &quot; + temp_table_name + &quot;) &quot;
    + &quot;and md5(concat_ws(&#39;&quot; + HASH_DELIMITER + &quot;&#39;, &quot; + ATTR_COL_STR + &quot;)) not in (select md5(concat_ws(&#39;&quot; + HASH_DELIMITER + &quot;&#39;, &quot; + ATTR_COL_STR + &quot;)) from &quot; + temp_table_name + &quot;) and current_flag = 1) as a &quot;
    + &quot;inner join (select * from &quot; + temp_table_name + &quot;) as b &quot;
    + &quot;on &quot; + On_string + &quot;) as c &quot;
    + &quot;where &quot; + TABLE_NAME + &quot;.current_flag = 1 and &quot; + WHERE_string;

  var response = snowflake.execute({
      sqlText: sql_str,    
  });
    
//  extract technical metadata from the Snowflake resultSet
  
  var sf_query_id = response.getQueryId();
  return_obj[&#39;update_records&#39;] = {}
  return_obj[&#39;update_records&#39;][&#39;sf_query_id&#39;] = sf_query_id;
  return_obj[&#39;update_records&#39;][&#39;sql_str&#39;] = sql_str;
  
  var sf_query_output_key = response.getColumnName(1);
  response.next();
  var sf_query_output_value = response.getColumnValue(1);
  return_obj[&#39;update_records&#39;][sf_query_output_key] = sf_query_output_value;
  
  
//  insert existing records with updates and new records
  var sql_str = &quot;insert into &quot; + TABLE_NAME
    + &quot; SELECT &quot; + PRIMARY_KEY_STR + &#39;, &#39; + ATTR_COL_STR + &quot;, system_valid_from, system_valid_to, 1 as current_flag&quot;
    + &quot;, &#39;&quot; + RUN_ID + &quot;&#39;, NULL&quot;
    + &quot;, current_timestamp(), NULL&quot;
    + &quot;, is_delete_flag&quot;
    + &quot;, &#39;&quot; + EXP_BATCH_DATETIME + &quot;&#39;::timestamp &quot;
    + &quot;from (select * from &quot; + temp_table_name
    + &quot; where md5(concat_ws(&#39;&quot; + HASH_DELIMITER + &quot;&#39;, &quot; + PRIMARY_KEY_STR + &quot;)) not in (select md5(concat_ws(&#39;&quot; + HASH_DELIMITER + &quot;&#39;, &quot; + PRIMARY_KEY_STR +&quot;)) from &quot; + TABLE_NAME + &quot;) &quot;
    + &quot;union &quot;
    + &quot;select * from &quot; + temp_table_name
    + &quot; where md5(concat_ws(&#39;&quot; + HASH_DELIMITER + &quot;&#39;, &quot; + PRIMARY_KEY_STR + &quot;)) in (select md5(concat_ws(&#39;&quot; + HASH_DELIMITER + &quot;&#39;, &quot; + PRIMARY_KEY_STR + &quot;)) from &quot; + TABLE_NAME + &quot;) and &quot;
    + &quot;md5(concat_ws(&#39;&quot; + HASH_DELIMITER + &quot;&#39;, &quot; + ATTR_COL_STR + &quot;)) not in (select md5(concat_ws(&#39;&quot; + HASH_DELIMITER + &quot;&#39;, &quot; + ATTR_COL_STR + &quot;)) from &quot; + TABLE_NAME + &quot;)) as a&quot;;

  var response = snowflake.execute({
      sqlText: sql_str,    
  });
    
//  extract technical metadata from the Snowflake resultSet
  
  var sf_query_id = response.getQueryId();
  return_obj[&#39;insert_records&#39;] = {}
  return_obj[&#39;insert_records&#39;][&#39;sf_query_id&#39;] = sf_query_id;
  return_obj[&#39;insert_records&#39;][&#39;sql_str&#39;] = sql_str;
  
  var sf_query_output_key = response.getColumnName(1);
  response.next();
  var sf_query_output_value = response.getColumnValue(1);
  return_obj[&#39;insert_records&#39;][sf_query_output_key] = sf_query_output_value;
  
  return_obj[&#39;status&#39;] = &#39;succeeded&#39;
  return_obj[&#39;detail&#39;] = &#39;Table &#39; + TABLE_NAME + &#39; has successfully performed upsert for batch &#39; + EXP_BATCH_DATETIME + &#39;. &#39;
  return JSON.stringify(return_obj)
  $$;
	
	
call scd_type2_loading(&#39;&lt;schema_name&gt;.dest_34&#39;, &#39;|@|&#39;,array_construct(&#39;col1&#39;), array_construct(&#39;col12&#39;, &#39;col13&#39;, &#39;col4&#39;),&#39;a6d012ba-2156-4993-97ba-2cfbbff120af&#39;, &#39;2021-01-26 09:00:00.000 -0000&#39;)
</pre>
</div></div><p>The relationship between tables in the POC is as follow:</p><div class="ap-container" id="ap-com.mxgraph.confluence.plugins.diagramly__drawio8777835324649292872">

  <div class="ap-content " id="embedded-com.mxgraph.confluence.plugins.diagramly__drawio8777835324649292872"></div>
  <script class="ap-iframe-body-script">
  (function(){
    var data = {
    "addon_key":"com.mxgraph.confluence.plugins.diagramly",
    "uniqueKey":"com.mxgraph.confluence.plugins.diagramly__drawio8777835324649292872",
    "key":"drawio",
     "moduleType":"dynamicContentMacros",      "moduleLocation":"content",         "cp":"/wiki",
            "general":"",
    "w":"",
    "h":"",
    "url":"https://ac.draw.io/connect/confluence/viewer-1-4-42.html?ceoId=606765065&diagramName=DW_POC_tables.svg&revision=3&width=1575.5&height=703&tbstyle=&simple=0&lbox=1&zoom=1&links=&owningPageId=606765065&displayName=DW_POC_tables.svg&contentId=&custContentId=624394952&contentVer=3&inComment=0&aspect=&pCenter=0&hiRes=&templateUrl=&tmpBuiltIn=&xdm_e=https%3A%2F%2Fvmia.atlassian.net&xdm_c=channel-com.mxgraph.confluence.plugins.diagramly__drawio8777835324649292872&cp=%2Fwiki&xdm_deprecated_addon_key_do_not_use=com.mxgraph.confluence.plugins.diagramly&lic=active&cv=1.1162.0",
        "structuredContext": "{\"license\":{\"active\":true},\"confluence\":{\"macro\":{\"outputType\":\"html_export\",\"hash\":\"d586d81d-f692-44ca-ab17-84e8d7b90bf9\",\"id\":\"d586d81d-f692-44ca-ab17-84e8d7b90bf9\"},\"content\":{\"type\":\"page\",\"version\":\"17\",\"id\":\"606765065\"},\"space\":{\"key\":\"SDI\",\"id\":\"262145\"}}}",
    "contentClassifier":"content",
    "productCtx":"{\"page.id\":\"606765065\",\"macro.hash\":\"d586d81d-f692-44ca-ab17-84e8d7b90bf9\",\"page.type\":\"page\",\"macro.localId\":\"\",\"simple\":\"0\",\"inComment\":\"0\",\": = | RAW | = :\":\"zoom=1|simple=0|inComment=0|pageId=606765065|custContentId=624394952|lbox=1|diagramDisplayName=DW_POC_tables.svg|contentVer=3|revision=3|baseUrl=https://vmia.atlassian.net/wiki|diagramName=DW_POC_tables.svg|pCenter=0|width=1575.5|links=|tbstyle=|height=703\",\"space.id\":\"262145\",\"diagramDisplayName\":\"DW_POC_tables.svg\",\"diagramName\":\"DW_POC_tables.svg\",\"links\":\"\",\"tbstyle\":\"\",\"height\":\"703\",\"space.key\":\"SDI\",\"user.id\":\"60c80092624d700069d68fe9\",\"content.version\":\"17\",\"page.title\":\"Data Warehouse Loading Process POC\",\"zoom\":\"1\",\"macro.body\":\"\",\"pageId\":\"606765065\",\"custContentId\":\"624394952\",\"macro.truncated\":\"false\",\"lbox\":\"1\",\"content.type\":\"page\",\"output.type\":\"html_export\",\"contentVer\":\"3\",\"page.version\":\"17\",\"revision\":\"3\",\"user.key\":\"8a7f808a79f96b90017a0d42d78807c4\",\"baseUrl\":\"https://vmia.atlassian.net/wiki\",\"pCenter\":\"0\",\"content.id\":\"606765065\",\"width\":\"1575.5\",\"macro.id\":\"d586d81d-f692-44ca-ab17-84e8d7b90bf9\"}",
    "timeZone":"UTC",
    "origin":"https://ac.draw.io",
    "hostOrigin":"https://vmia.atlassian.net",
    "sandbox":"allow-downloads allow-forms allow-modals allow-popups allow-scripts allow-same-origin allow-top-navigation-by-user-activation allow-storage-access-by-user-activation",    "pearApp":"true",        "apiMigrations": {
        "gdpr": true
    }
}
;
    if(window.AP && window.AP.subCreate) {
      window._AP.appendConnectAddon(data);
    } else {
      require(['ac/create'], function(create){
        create.appendConnectAddon(data);
      });
    }
  }());
</script>
</div>
<h2 id="DataWarehouseLoadingProcessPOC-Step4:BuildthePipelineinADF">Step 4: Build the Pipeline in ADF</h2><ul><li><p>For the purpose of POC, we only build the most complicated section the <strong>Star Schema Pipeline</strong> in which there are two ForEach loops running in sequence and/or parallel.</p><ul><li><span class="confluence-embedded-file-wrapper image-center-wrapper"><img class="confluence-embedded-image image-center" loading="lazy" src="attachments/606765065/621478234.png" data-image-src="attachments/606765065/621478234.png" data-height="238" data-width="1428" data-unresolved-comment-count="0" data-linked-resource-id="621478234" data-linked-resource-version="1" data-linked-resource-type="attachment" data-linked-resource-default-alias="image-20210203-043816.png" data-base-url="https://vmia.atlassian.net/wiki" data-linked-resource-content-type="image/png" data-linked-resource-container-id="606765065" data-linked-resource-container-version="17" data-media-id="f16b2bdd-9493-4c44-8808-2a3707ac96e1" data-media-type="file"></span><p>In <strong>ADF </strong>(refer to <a href="https://vmia.atlassian.net/wiki/spaces/SDI/pages/606765065/Data+Warehouse+Loading+Process+POC#Variation-to-the-Original-Design" data-card-appearance="inline" rel="nofollow">https://vmia.atlassian.net/wiki/spaces/SDI/pages/606765065/Data+Warehouse+Loading+Process+POC#Variation-to-the-Original-Design</a>  for variations in implementation based on the initial design)</p></li></ul></li></ul><div class="ap-container" id="ap-com.mxgraph.confluence.plugins.diagramly__drawio7376793550508436894">

  <div class="ap-content " id="embedded-com.mxgraph.confluence.plugins.diagramly__drawio7376793550508436894"></div>
  <script class="ap-iframe-body-script">
  (function(){
    var data = {
    "addon_key":"com.mxgraph.confluence.plugins.diagramly",
    "uniqueKey":"com.mxgraph.confluence.plugins.diagramly__drawio7376793550508436894",
    "key":"drawio",
     "moduleType":"dynamicContentMacros",      "moduleLocation":"content",         "cp":"/wiki",
            "general":"",
    "w":"",
    "h":"",
    "url":"https://ac.draw.io/connect/confluence/viewer-1-4-42.html?ceoId=606765065&diagramName=ADF_DW_POC.svg&revision=1&width=1961&height=1151&tbstyle=&simple=0&lbox=1&zoom=1&links=&owningPageId=606765065&displayName=ADF_DW_POC.svg&contentId=&custContentId=621478277&contentVer=1&inComment=0&aspect=&pCenter=0&hiRes=&templateUrl=&tmpBuiltIn=&xdm_e=https%3A%2F%2Fvmia.atlassian.net&xdm_c=channel-com.mxgraph.confluence.plugins.diagramly__drawio7376793550508436894&cp=%2Fwiki&xdm_deprecated_addon_key_do_not_use=com.mxgraph.confluence.plugins.diagramly&lic=active&cv=1.1162.0",
        "structuredContext": "{\"license\":{\"active\":true},\"confluence\":{\"macro\":{\"outputType\":\"html_export\",\"hash\":\"28b0e5bd-315a-481b-858f-482f44ba2b4a\",\"id\":\"28b0e5bd-315a-481b-858f-482f44ba2b4a\"},\"content\":{\"type\":\"page\",\"version\":\"17\",\"id\":\"606765065\"},\"space\":{\"key\":\"SDI\",\"id\":\"262145\"}}}",
    "contentClassifier":"content",
    "productCtx":"{\"page.id\":\"606765065\",\"macro.hash\":\"28b0e5bd-315a-481b-858f-482f44ba2b4a\",\"page.type\":\"page\",\"macro.localId\":\"\",\"simple\":\"0\",\"inComment\":\"0\",\": = | RAW | = :\":\"zoom=1|simple=0|inComment=0|pageId=606765065|custContentId=621478277|lbox=1|diagramDisplayName=ADF_DW_POC.svg|contentVer=1|revision=1|baseUrl=https://vmia.atlassian.net/wiki|diagramName=ADF_DW_POC.svg|pCenter=0|width=1961|links=|tbstyle=|height=1151\",\"space.id\":\"262145\",\"diagramDisplayName\":\"ADF_DW_POC.svg\",\"diagramName\":\"ADF_DW_POC.svg\",\"links\":\"\",\"tbstyle\":\"\",\"height\":\"1151\",\"space.key\":\"SDI\",\"user.id\":\"60c80092624d700069d68fe9\",\"content.version\":\"17\",\"page.title\":\"Data Warehouse Loading Process POC\",\"zoom\":\"1\",\"macro.body\":\"\",\"pageId\":\"606765065\",\"custContentId\":\"621478277\",\"macro.truncated\":\"false\",\"lbox\":\"1\",\"content.type\":\"page\",\"output.type\":\"html_export\",\"contentVer\":\"1\",\"page.version\":\"17\",\"revision\":\"1\",\"user.key\":\"8a7f808a79f96b90017a0d42d78807c4\",\"baseUrl\":\"https://vmia.atlassian.net/wiki\",\"pCenter\":\"0\",\"content.id\":\"606765065\",\"width\":\"1961\",\"macro.id\":\"28b0e5bd-315a-481b-858f-482f44ba2b4a\"}",
    "timeZone":"UTC",
    "origin":"https://ac.draw.io",
    "hostOrigin":"https://vmia.atlassian.net",
    "sandbox":"allow-downloads allow-forms allow-modals allow-popups allow-scripts allow-same-origin allow-top-navigation-by-user-activation allow-storage-access-by-user-activation",    "pearApp":"true",        "apiMigrations": {
        "gdpr": true
    }
}
;
    if(window.AP && window.AP.subCreate) {
      window._AP.appendConnectAddon(data);
    } else {
      require(['ac/create'], function(create){
        create.appendConnectAddon(data);
      });
    }
  }());
</script>
</div>
<ul><li><p>This step takes <strong>most of the time</strong> to design the suitable config structure, use parameters to propagate dynamic values, check the output, and construct dynamic CosmosDB SQL queries and Snowflake stored procedure calling queries.</p></li><li><p>There are <strong>two pain points</strong> for this step:</p><ul><li><p><strong>Check the value</strong> of a parameter, output of an activity, dynamic values. To address this, we leverage <strong>User Properties</strong>. You can use it display query and input in the log. Recommend to use User Properties for all primary activities.</p><ul><li><span class="confluence-embedded-file-wrapper image-center-wrapper"><img class="confluence-embedded-image image-center" loading="lazy" src="attachments/606765065/621478199.png" data-image-src="attachments/606765065/621478199.png" data-height="398" data-width="758" data-unresolved-comment-count="0" data-linked-resource-id="621478199" data-linked-resource-version="1" data-linked-resource-type="attachment" data-linked-resource-default-alias="image-20210203-041616.png" data-base-url="https://vmia.atlassian.net/wiki" data-linked-resource-content-type="image/png" data-linked-resource-container-id="606765065" data-linked-resource-container-version="17" data-media-id="c29ab6ef-4958-4c27-9e7c-d4470ed7d09b" data-media-type="file"></span><span class="confluence-embedded-file-wrapper image-center-wrapper"><img class="confluence-embedded-image image-center" loading="lazy" src="attachments/606765065/621609217.png" data-image-src="attachments/606765065/621609217.png" data-height="282" data-width="1282" data-unresolved-comment-count="0" data-linked-resource-id="621609217" data-linked-resource-version="1" data-linked-resource-type="attachment" data-linked-resource-default-alias="image-20210203-041736.png" data-base-url="https://vmia.atlassian.net/wiki" data-linked-resource-content-type="image/png" data-linked-resource-container-id="606765065" data-linked-resource-container-version="17" data-media-id="2feea1ad-8c35-4a0e-8457-ee283ccb0f4c" data-media-type="file"></span></li><li><p>As <strong>constructing a dynamic query</strong> requires concatenating short strings and parameters together, the <strong>escaping quotes</strong> can be handled differently for different queries.</p><ul><li><p>for <strong>CosmosDB query</strong>, because there is no differentiation between double and single quote, and in ADF expression string needs to wrap around in single quote, we can use <strong>double quotes to avoid escaping quotes</strong>:</p></li><li><div class="code panel pdl" style="border-width: 1px;"><div class="codeContent panelContent pdl">
<pre class="syntaxhighlighter-pre" data-syntaxhighlighter-params="brush: java; gutter: false; theme: Confluence" data-theme="Confluence"># a cosmosDB query
select * from c where c.table_type = &#39;dim&#39; order by c.sequence_by_table

# the dynamic query string in ADF (note that the single quotes in the above query need to be changed to double quotes as shown below)
@concat(&#39;select * from c where c.table_type = &quot;&#39;,item().id, &#39;&quot;&#39;, &#39; order by c.sequence_by_table&#39;)</pre>
</div></div><p /></li><li><p>For <strong>Snowflake query</strong>, because the double-quoted string is case sensitive and double quotes and single quotes are used differently, and in ADF expression string needs to wrap around in single quote, we need to use <strong>two single quotes to escape quotes</strong>.</p><ul><li><div class="code panel pdl" style="border-width: 1px;"><div class="codeContent panelContent pdl">
<pre class="syntaxhighlighter-pre" data-syntaxhighlighter-params="brush: java; gutter: false; theme: Confluence" data-theme="Confluence"># a snowflake query
call create_dim_dest_12_transient(&#39;schema1.dim_dest_12_transient&#39;
, &#39;9999-12-31 00:00:00.000 -0800&#39;
, &#39;2021-01-21 15:56:26.342 -0800&#39;)

# the dynamic query string in ADF
@concat(&#39;call &#39;
, item().bespke_stored_procedure
, &#39;(&#39;&#39;&#39;, item().schema_name,&#39;.&#39;,item().id,&#39;&#39;&#39;
, &#39;&#39;&#39;, pipeline().parameters.high_enddate,&#39;&#39;&#39;
, &#39;&#39;&#39;, pipeline().parameters.exp_batch_datetime,&#39;&#39;&#39;)&#39;)</pre>
</div></div><p /></li><li><p>Determine the right number of single quotes can get quite complicated in terms of how many single quotes to have. One way to improve the developer experience is to (as shown in the example) to <strong>bring each value to its separate row</strong> to have a clear boundary. Also, <strong>leverage the expression editor built in the ADF</strong> to validate the syntax and inform if any missing or extra single quotes.</p></li></ul></li></ul></li></ul></li></ul></li></ul><h1 id="DataWarehouseLoadingProcessPOC-VariationtotheOriginalDesign">Variation to the Original Design</h1><h2 id="DataWarehouseLoadingProcessPOC-ChangenestedForEachLoopintoForEachLoop+sub-pipelinefortheStarSchemaPipeline">Change nested ForEach Loop into ForEach Loop + sub-pipeline for the Star Schema Pipeline</h2><p>ADF doesn’t support nested ForEach Loop as in the design for the Star Schema Pipeline. A workaround is to put the 2nd ForEach Loop into a sub-pipeline. The first ForEach Loop will use the Execute Pipeline Activity to invoke the sub-pipeline. <strong>Note</strong>: to establish the Azure Monitor Log traceability, include the sub-pipeline name into the name of the Execute Pipeline Activity. See the screenshot below where the Execute Pipeline Activity name doesn’t contain the traceable name.</p><span class="confluence-embedded-file-wrapper image-center-wrapper"><img class="confluence-embedded-image image-center" loading="lazy" src="attachments/606765065/615284805.png" data-image-src="attachments/606765065/615284805.png" data-height="271" data-width="1278" data-unresolved-comment-count="0" data-linked-resource-id="615284805" data-linked-resource-version="1" data-linked-resource-type="attachment" data-linked-resource-default-alias="image-20210201-031439.png" data-base-url="https://vmia.atlassian.net/wiki" data-linked-resource-content-type="image/png" data-linked-resource-container-id="606765065" data-linked-resource-container-version="17" data-media-id="b9f20e21-2024-487b-bf0d-8b460761b0c6" data-media-type="file"></span><span class="confluence-embedded-file-wrapper image-center-wrapper"><img class="confluence-embedded-image image-center" loading="lazy" src="attachments/606765065/615448644.png" data-image-src="attachments/606765065/615448644.png" data-height="552" data-width="1290" data-unresolved-comment-count="0" data-linked-resource-id="615448644" data-linked-resource-version="1" data-linked-resource-type="attachment" data-linked-resource-default-alias="image-20210201-031518.png" data-base-url="https://vmia.atlassian.net/wiki" data-linked-resource-content-type="image/png" data-linked-resource-container-id="606765065" data-linked-resource-container-version="17" data-media-id="859888d1-75ff-4094-8dd2-33c5c794f7b0" data-media-type="file"></span><h2 id="DataWarehouseLoadingProcessPOC-SplittheExecuteLoadingStoredProcedureintoThreeModularisedStoredProcedure">Split the Execute Loading Stored Procedure into Three Modularised Stored Procedure</h2><p>As illustrated in the design diagram and the implementation pipeline graph (in section <a href="https://vmia.atlassian.net/wiki/spaces/SDI/pages/606765065/Data+Warehouse+Loading+Process+POC#Step-4%3A-Build-the-Pipeline-in-ADF" rel="nofollow"><strong>Step 4: Build the Pipeline in ADF</strong></a>), the implementation split the proposed initially one stored procedure into three:</p><ul><li><p><strong>check_if_process</strong>: check whether there is any record in the destination table with the same EXP_BATCH_DATETIME.</p></li><li><p><strong>bespoke_create_transient</strong>: apply bespoke joins and filters and create a transient table which contains the delta snapshot of the current batch. This activity <strong>calls different stored procedures</strong> based on the name of the destination table.</p></li><li><p><strong>generic_dw_loading</strong>: perform a type2 loading of data from the transient data into the destination table.</p></li></ul><p>The <strong>advantage</strong> of this split is that the main logic is surfaced to the ADF pipeline. Each stored procedure only performs a straightforward procedure, making the code more manageable and swappable (for different destination tables, swap in different bespoke_create_transient code).</p><h1 id="DataWarehouseLoadingProcessPOC-Config">Config</h1><h2 id="DataWarehouseLoadingProcessPOC-TableTypeConfig">Table Type Config</h2><p>This is to record the mapping between table type and their sequence. Each item is per type.</p><div class="code panel pdl" style="border-width: 1px;"><div class="codeContent panelContent pdl">
<pre class="syntaxhighlighter-pre" data-syntaxhighlighter-params="brush: java; gutter: false; theme: Confluence" data-theme="Confluence">{
  &quot;id&quot;: &quot;fact&quot;,
  &quot;sequence_by_type&quot;: 2,
  &quot;stored_procedure&quot;: {
      &quot;processed_check_sp&quot;: &quot;check_if_processed&quot;,
      &quot;table_loading_sp&quot;: &quot;scd_type2_loading&quot;
  }
}</pre>
</div></div><h2 id="DataWarehouseLoadingProcessPOC-TableConfig">Table Config</h2><p>This is to record the parameters for stored procedures of each data warehouse table and their execution sequence. Each item is per table.</p><div class="code panel pdl" style="border-width: 1px;"><div class="codeContent panelContent pdl">
<pre class="syntaxhighlighter-pre" data-syntaxhighlighter-params="brush: java; gutter: false; theme: Confluence" data-theme="Confluence">{
  &quot;id&quot;: &quot;dest_56&quot;,
  &quot;table_type&quot;: &quot;fact&quot;,
  &quot;schema_name&quot;: &quot;&lt;schema_name&gt;&quot;,
  &quot;sequence_by_table&quot;: 1,
  &quot;bespke_stored_procedure&quot;: &quot;create_fact_table_56_transient&quot;,
  &quot;primary_key_list&quot;: [
      &quot;col1&quot;
  ],
  &quot;attr_col_list&quot;: [
      &quot;col12&quot;,
      &quot;col13&quot;,
      &quot;col4&quot;
  ]
}</pre>
</div></div><p><strong><span style="color: rgb(255,86,48);">Note</span></strong>: </p><ul><li><p>If possible, incorporate this config into an existing config to reduce the number of configs.</p></li><li><p>Have considered incorporating the Table Type Config into the Table Config and using a GROUP BY and ORDER BY to achieve the same result. However, Azure CosmosDB doesn’t support using GROUP BY and ORDER BY together.</p></li></ul><h1 id="DataWarehouseLoadingProcessPOC-DevelopmentandDebuginADP">Development and Debug in ADP</h1><h2 id="DataWarehouseLoadingProcessPOC-LookupActivity">Lookup Activity</h2><p>One of the uses of Lookup Activity is to retrieve config information from the CosmosDB using SQL query. One way to develop the query is to leverage the editing UI in CosmosDB. You can use the Debug function in ADF (as shown in the screenshot below). The Error details would return the message you would see in the system you’re directly interacting with.</p><span class="confluence-embedded-file-wrapper image-center-wrapper"><img class="confluence-embedded-image image-center" loading="lazy" src="attachments/606765065/615219258.png" data-image-src="attachments/606765065/615219258.png" data-height="559" data-width="1223" data-unresolved-comment-count="0" data-linked-resource-id="615219258" data-linked-resource-version="1" data-linked-resource-type="attachment" data-linked-resource-default-alias="image-20210201-025554.png" data-base-url="https://vmia.atlassian.net/wiki" data-linked-resource-content-type="image/png" data-linked-resource-container-id="606765065" data-linked-resource-container-version="17" data-media-id="bf5a520a-baba-46f4-801e-93c18caed524" data-media-type="file"></span><h2 id="DataWarehouseLoadingProcessPOC-ForEachLoop">ForEach Loop</h2><p>The use of the ForEach Loop is to run multiple activities or sub-pipelines in parallel. To reveal what values got passed on in each iteration in a loop, can use User Properties and cast the value to String.</p><span class="confluence-embedded-file-wrapper image-center-wrapper"><img class="confluence-embedded-image image-center" loading="lazy" src="attachments/606765065/615317558.png" data-image-src="attachments/606765065/615317558.png" data-height="471" data-width="621" data-unresolved-comment-count="0" data-linked-resource-id="615317558" data-linked-resource-version="1" data-linked-resource-type="attachment" data-linked-resource-default-alias="image-20210201-030409.png" data-base-url="https://vmia.atlassian.net/wiki" data-linked-resource-content-type="image/png" data-linked-resource-container-id="606765065" data-linked-resource-container-version="17" data-media-id="4381e0be-b686-42f4-853f-af885eeb6b9a" data-media-type="file"></span><p>Run the pipeline using Add Trigger, and check the Azure Monitor log. The defined the User Property field will show the value. Add the User Property field to the table if you a long list of activities (unfortunately you have to do it every time).</p><span class="confluence-embedded-file-wrapper image-center-wrapper"><img class="confluence-embedded-image image-center" loading="lazy" src="attachments/606765065/606241138.png" data-image-src="attachments/606765065/606241138.png" data-height="557" data-width="1301" data-unresolved-comment-count="0" data-linked-resource-id="606241138" data-linked-resource-version="1" data-linked-resource-type="attachment" data-linked-resource-default-alias="image-20210201-030519.png" data-base-url="https://vmia.atlassian.net/wiki" data-linked-resource-content-type="image/png" data-linked-resource-container-id="606765065" data-linked-resource-container-version="17" data-media-id="58179e69-3fb6-4165-8152-51a1b0c6a1fd" data-media-type="file"></span><p>User Properties is also a useful tool to display any dynamic queries.</p><span class="confluence-embedded-file-wrapper image-center-wrapper"><img class="confluence-embedded-image image-center" loading="lazy" src="attachments/606765065/624755366.png" data-image-src="attachments/606765065/624755366.png" data-height="649" data-width="1221" data-unresolved-comment-count="0" data-linked-resource-id="624755366" data-linked-resource-version="1" data-linked-resource-type="attachment" data-linked-resource-default-alias="image-20210204-014833.png" data-base-url="https://vmia.atlassian.net/wiki" data-linked-resource-content-type="image/png" data-linked-resource-container-id="606765065" data-linked-resource-container-version="17" data-media-id="3bc6d3d5-4acb-4f1c-a0e9-8898ba25bbdc" data-media-type="file"></span><span class="confluence-embedded-file-wrapper image-center-wrapper"><img class="confluence-embedded-image image-center" loading="lazy" src="attachments/606765065/624755374.png" data-image-src="attachments/606765065/624755374.png" data-height="422" data-width="1109" data-unresolved-comment-count="0" data-linked-resource-id="624755374" data-linked-resource-version="1" data-linked-resource-type="attachment" data-linked-resource-default-alias="image-20210204-014914.png" data-base-url="https://vmia.atlassian.net/wiki" data-linked-resource-content-type="image/png" data-linked-resource-container-id="606765065" data-linked-resource-container-version="17" data-media-id="975a4afa-8854-45e9-b671-451e03e7d67d" data-media-type="file"></span><p>In the Azure Monitor Log,</p><span class="confluence-embedded-file-wrapper image-center-wrapper"><img class="confluence-embedded-image image-center" loading="lazy" src="attachments/606765065/624722550.png" data-image-src="attachments/606765065/624722550.png" data-height="379" data-width="1290" data-unresolved-comment-count="0" data-linked-resource-id="624722550" data-linked-resource-version="1" data-linked-resource-type="attachment" data-linked-resource-default-alias="image-20210204-015029.png" data-base-url="https://vmia.atlassian.net/wiki" data-linked-resource-content-type="image/png" data-linked-resource-container-id="606765065" data-linked-resource-container-version="17" data-media-id="a73310b9-330c-4fc5-9bc6-1407c2c576eb" data-media-type="file"></span><p />
                    </div>

                                        <div class="pageSection group">
                        <div class="pageSectionHeader">
                            <h2 id="attachments" class="pageSectionTitle">Attachments:</h2>
                        </div>

                        <div class="greybox" align="left">
                                                            <img src="images/icons/bullet_blue.gif" height="8" width="8" alt=""/>
                                <a href="attachments/606765065/615219258.png">image-20210201-025554.png</a> (image/png)
                                <br/>
                                                            <img src="images/icons/bullet_blue.gif" height="8" width="8" alt=""/>
                                <a href="attachments/606765065/606404887.png">image-20210201-030218.png</a> (image/png)
                                <br/>
                                                            <img src="images/icons/bullet_blue.gif" height="8" width="8" alt=""/>
                                <a href="attachments/606765065/615317558.png">image-20210201-030409.png</a> (image/png)
                                <br/>
                                                            <img src="images/icons/bullet_blue.gif" height="8" width="8" alt=""/>
                                <a href="attachments/606765065/606241138.png">image-20210201-030519.png</a> (image/png)
                                <br/>
                                                            <img src="images/icons/bullet_blue.gif" height="8" width="8" alt=""/>
                                <a href="attachments/606765065/615284805.png">image-20210201-031439.png</a> (image/png)
                                <br/>
                                                            <img src="images/icons/bullet_blue.gif" height="8" width="8" alt=""/>
                                <a href="attachments/606765065/615448644.png">image-20210201-031518.png</a> (image/png)
                                <br/>
                                                            <img src="images/icons/bullet_blue.gif" height="8" width="8" alt=""/>
                                <a href="attachments/606765065/621478199.png">image-20210203-041616.png</a> (image/png)
                                <br/>
                                                            <img src="images/icons/bullet_blue.gif" height="8" width="8" alt=""/>
                                <a href="attachments/606765065/621609217.png">image-20210203-041736.png</a> (image/png)
                                <br/>
                                                            <img src="images/icons/bullet_blue.gif" height="8" width="8" alt=""/>
                                <a href="attachments/606765065/621478234.png">image-20210203-043816.png</a> (image/png)
                                <br/>
                                                            <img src="images/icons/bullet_blue.gif" height="8" width="8" alt=""/>
                                <a href="attachments/606765065/621478268.tmp">~drawio~5dc205aeb6e6b50c58aeca8b~ADF_DW_POC.svg.tmp</a> (application/vnd.jgraph.mxfile)
                                <br/>
                                                            <img src="images/icons/bullet_blue.gif" height="8" width="8" alt=""/>
                                <a href="attachments/606765065/621019551.tmp">~drawio~5dc205aeb6e6b50c58aeca8b~ADF_DW_POC.svg.tmp</a> (application/vnd.jgraph.mxfile)
                                <br/>
                                                            <img src="images/icons/bullet_blue.gif" height="8" width="8" alt=""/>
                                <a href="attachments/606765065/621543804.tmp">~drawio~5dc205aeb6e6b50c58aeca8b~ADF_DW_POC.svg.tmp</a> (application/vnd.jgraph.mxfile)
                                <br/>
                                                            <img src="images/icons/bullet_blue.gif" height="8" width="8" alt=""/>
                                <a href="attachments/606765065/621379921.tmp">~drawio~5dc205aeb6e6b50c58aeca8b~ADF_DW_POC.svg.tmp</a> (application/vnd.jgraph.mxfile)
                                <br/>
                                                            <img src="images/icons/bullet_blue.gif" height="8" width="8" alt=""/>
                                <a href="attachments/606765065/621379930.tmp">~drawio~5dc205aeb6e6b50c58aeca8b~ADF_DW_POC.svg.tmp</a> (application/vnd.jgraph.mxfile)
                                <br/>
                                                            <img src="images/icons/bullet_blue.gif" height="8" width="8" alt=""/>
                                <a href="attachments/606765065/621445520.tmp">~drawio~5dc205aeb6e6b50c58aeca8b~ADF_DW_POC.svg.tmp</a> (application/vnd.jgraph.mxfile)
                                <br/>
                                                            <img src="images/icons/bullet_blue.gif" height="8" width="8" alt=""/>
                                <a href="attachments/606765065/621642082.tmp">~drawio~5dc205aeb6e6b50c58aeca8b~ADF_DW_POC.svg.tmp</a> (application/vnd.jgraph.mxfile)
                                <br/>
                                                            <img src="images/icons/bullet_blue.gif" height="8" width="8" alt=""/>
                                <a href="attachments/606765065/621118012.tmp">~drawio~5dc205aeb6e6b50c58aeca8b~ADF_DW_POC.svg.tmp</a> (application/vnd.jgraph.mxfile)
                                <br/>
                                                            <img src="images/icons/bullet_blue.gif" height="8" width="8" alt=""/>
                                <a href="attachments/606765065/621118021.tmp">~drawio~5dc205aeb6e6b50c58aeca8b~ADF_DW_POC.svg.tmp</a> (application/vnd.jgraph.mxfile)
                                <br/>
                                                            <img src="images/icons/bullet_blue.gif" height="8" width="8" alt=""/>
                                <a href="attachments/606765065/621576620.tmp">~drawio~5dc205aeb6e6b50c58aeca8b~ADF_DW_POC.svg.tmp</a> (application/vnd.jgraph.mxfile)
                                <br/>
                                                            <img src="images/icons/bullet_blue.gif" height="8" width="8" alt=""/>
                                <a href="attachments/606765065/621576655.svg">ADF_DW_POC.svg</a> (application/vnd.jgraph.mxfile)
                                <br/>
                                                            <img src="images/icons/bullet_blue.gif" height="8" width="8" alt=""/>
                                <a href="attachments/606765065/621412682.png">ADF_DW_POC.svg.png</a> (image/png)
                                <br/>
                                                            <img src="images/icons/bullet_blue.gif" height="8" width="8" alt=""/>
                                <a href="attachments/606765065/624493246.tmp">~drawio~5dc205aeb6e6b50c58aeca8b~DW_POC_tables.svg.tmp</a> (application/vnd.jgraph.mxfile)
                                <br/>
                                                            <img src="images/icons/bullet_blue.gif" height="8" width="8" alt=""/>
                                <a href="attachments/606765065/624624275.tmp">~drawio~5dc205aeb6e6b50c58aeca8b~DW_POC_tables.svg.tmp</a> (application/vnd.jgraph.mxfile)
                                <br/>
                                                            <img src="images/icons/bullet_blue.gif" height="8" width="8" alt=""/>
                                <a href="attachments/606765065/624493259.tmp">~drawio~5dc205aeb6e6b50c58aeca8b~DW_POC_tables.svg.tmp</a> (application/vnd.jgraph.mxfile)
                                <br/>
                                                            <img src="images/icons/bullet_blue.gif" height="8" width="8" alt=""/>
                                <a href="attachments/606765065/624460404.tmp">~drawio~5dc205aeb6e6b50c58aeca8b~DW_POC_tables.svg.tmp</a> (application/vnd.jgraph.mxfile)
                                <br/>
                                                            <img src="images/icons/bullet_blue.gif" height="8" width="8" alt=""/>
                                <a href="attachments/606765065/624624284.tmp">~drawio~5dc205aeb6e6b50c58aeca8b~DW_POC_tables.svg.tmp</a> (application/vnd.jgraph.mxfile)
                                <br/>
                                                            <img src="images/icons/bullet_blue.gif" height="8" width="8" alt=""/>
                                <a href="attachments/606765065/624591550.tmp">~drawio~5dc205aeb6e6b50c58aeca8b~DW_POC_tables.svg.tmp</a> (application/vnd.jgraph.mxfile)
                                <br/>
                                                            <img src="images/icons/bullet_blue.gif" height="8" width="8" alt=""/>
                                <a href="attachments/606765065/624460413.tmp">~drawio~5dc205aeb6e6b50c58aeca8b~DW_POC_tables.svg.tmp</a> (application/vnd.jgraph.mxfile)
                                <br/>
                                                            <img src="images/icons/bullet_blue.gif" height="8" width="8" alt=""/>
                                <a href="attachments/606765065/624755178.tmp">~drawio~5dc205aeb6e6b50c58aeca8b~DW_POC_tables.svg.tmp</a> (application/vnd.jgraph.mxfile)
                                <br/>
                                                            <img src="images/icons/bullet_blue.gif" height="8" width="8" alt=""/>
                                <a href="attachments/606765065/624525984.tmp">~drawio~5dc205aeb6e6b50c58aeca8b~DW_POC_tables.svg.tmp</a> (application/vnd.jgraph.mxfile)
                                <br/>
                                                            <img src="images/icons/bullet_blue.gif" height="8" width="8" alt=""/>
                                <a href="attachments/606765065/624362265.tmp">~drawio~5dc205aeb6e6b50c58aeca8b~DW_POC_tables.svg.tmp</a> (application/vnd.jgraph.mxfile)
                                <br/>
                                                            <img src="images/icons/bullet_blue.gif" height="8" width="8" alt=""/>
                                <a href="attachments/606765065/624591568.svg">DW_POC_tables.svg</a> (application/vnd.jgraph.mxfile)
                                <br/>
                                                            <img src="images/icons/bullet_blue.gif" height="8" width="8" alt=""/>
                                <a href="attachments/606765065/624722336.png">DW_POC_tables.svg.png</a> (image/png)
                                <br/>
                                                            <img src="images/icons/bullet_blue.gif" height="8" width="8" alt=""/>
                                <a href="attachments/606765065/624361502.tmp">~drawio~5dc205aeb6e6b50c58aeca8b~DW_POC_tables.svg.tmp</a> (application/vnd.jgraph.mxfile)
                                <br/>
                                                            <img src="images/icons/bullet_blue.gif" height="8" width="8" alt=""/>
                                <a href="attachments/606765065/624494006.tmp">~DW_POC_tables.svg.tmp</a> (application/vnd.jgraph.mxfile)
                                <br/>
                                                            <img src="images/icons/bullet_blue.gif" height="8" width="8" alt=""/>
                                <a href="attachments/606765065/624592179.svg">DW_POC_tables.svg</a> (application/vnd.jgraph.mxfile)
                                <br/>
                                                            <img src="images/icons/bullet_blue.gif" height="8" width="8" alt=""/>
                                <a href="attachments/606765065/624362832.png">DW_POC_tables.svg.png</a> (image/png)
                                <br/>
                                                            <img src="images/icons/bullet_blue.gif" height="8" width="8" alt=""/>
                                <a href="attachments/606765065/624755366.png">image-20210204-014833.png</a> (image/png)
                                <br/>
                                                            <img src="images/icons/bullet_blue.gif" height="8" width="8" alt=""/>
                                <a href="attachments/606765065/624755374.png">image-20210204-014914.png</a> (image/png)
                                <br/>
                                                            <img src="images/icons/bullet_blue.gif" height="8" width="8" alt=""/>
                                <a href="attachments/606765065/624722550.png">image-20210204-015029.png</a> (image/png)
                                <br/>
                                                            <img src="images/icons/bullet_blue.gif" height="8" width="8" alt=""/>
                                <a href="attachments/606765065/624591563.tmp">~DW_POC_tables.svg.tmp</a> (application/vnd.jgraph.mxfile)
                                <br/>
                                                            <img src="images/icons/bullet_blue.gif" height="8" width="8" alt=""/>
                                <a href="attachments/606765065/624394947.svg">DW_POC_tables.svg</a> (application/vnd.jgraph.mxfile)
                                <br/>
                                                            <img src="images/icons/bullet_blue.gif" height="8" width="8" alt=""/>
                                <a href="attachments/606765065/624329345.png">DW_POC_tables.svg.png</a> (image/png)
                                <br/>
                                                    </div>
                    </div>
                    
                                                      
                </div>             </div> 
            <div id="footer" role="contentinfo">
                <section class="footer-body">
                    <p>Document generated by Confluence on Dec 15, 2021 03:38</p>
                    <div id="footer-logo"><a href="http://www.atlassian.com/">Atlassian</a></div>
                </section>
            </div>
        </div>     </body>
</html>
